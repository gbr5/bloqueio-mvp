// Bloqueio Game - Prisma Schema
// Phase 2: Adding Better Auth models for user authentication

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BETTER AUTH MODELS (User Authentication)
// ============================================

// User account (Better Auth core model)
model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  sessions Session[]
  accounts Account[]

  // Custom fields for game stats
  gamesPlayed Int @default(0)
  gamesWon    Int @default(0)

  @@index([email])
}

// Session (Better Auth core model)
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
}

// Account (Better Auth core model - for OAuth providers)
model Account {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId             String // Provider's user ID
  providerId            String // "github", "google", etc.
  accessToken           String?
  refreshToken          String?
  idToken               String? // ID token from OAuth provider (Google, etc.)
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String? // For email/password auth
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

// Verification (Better Auth core model - for email verification)
model Verification {
  id         String   @id @default(cuid())
  identifier String // Email or phone
  value      String // Verification code
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

// ============================================
// GAME MODELS
// ============================================

// Room represents a game session
model Room {
  id          String     @id @default(cuid())
  code        String     @unique // 6-character code (R7IAG2)
  status      RoomStatus @default(WAITING)
  hostId      String? // Session ID of player who created the room
  currentTurn Int        @default(0) // Current player ID (0-3)
  winner      Int? // Winning player ID
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  players  Player[]
  barriers Barrier[]
  moves    Move[] // Move history for undo

  @@index([code])
  @@index([status])
}

enum RoomStatus {
  WAITING // Lobby - players joining
  PLAYING // Game in progress
  FINISHED // Game over
}

// Player in a specific room
model Player {
  id     String @id @default(cuid())
  roomId String
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Identity - can be linked to User account OR use sessionId for guests
  userId    String? // Optional link to Better Auth User (null for guest players)
  sessionId String // Server-generated session ID from cookies (for all players)

  playerId Int // 0-3 (position in game)
  name     String // User's name or "Guest Player X"
  color    String // "#ef4444", "#3b82f6", etc.

  // Game position - CORRECTED starting positions (first cell AFTER border)
  row       Int // Current row position
  col       Int // Current column position
  wallsLeft Int      @default(6)
  goalSide  GoalSide

  joinedAt   DateTime @default(now())
  lastActive DateTime @updatedAt

  @@unique([roomId, sessionId]) // One player per session per room
  @@unique([roomId, playerId]) // Each slot 0-3 is unique per room
  @@unique([roomId, userId]) // Each user can only join once per room (if logged in)
  @@index([sessionId])
  @@index([userId])
}

enum GoalSide {
  TOP
  RIGHT
  BOTTOM
  LEFT
}

// Barrier placed on the board
model Barrier {
  id          String             @id @default(cuid())
  roomId      String
  room        Room               @relation(fields: [roomId], references: [id], onDelete: Cascade)
  row         Int // Base row (top-left of 2x2 area)
  col         Int // Base column
  orientation BarrierOrientation
  placedBy    Int // Player ID who placed it
  createdAt   DateTime           @default(now())

  @@index([roomId])
}

enum BarrierOrientation {
  HORIZONTAL
  VERTICAL
}

// Move history (for undo feature)
model Move {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  playerId  Int // Player who made the move
  fromRow   Int
  fromCol   Int
  toRow     Int
  toCol     Int
  createdAt DateTime @default(now())

  @@index([roomId])
  @@index([createdAt])
}
